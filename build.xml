<?xml version="1.0" encoding="UTF-8"?>

<project name="deploy" default="deploy:start">

  <!-- ## Properties -->

  <property name="deploy.environment"  value="" />
  <property name="deploy.sourcedir"    value="${project.basedir}/docroot" />

  <property name="deploy.ssh.host"     value="" />
  <property name="deploy.ssh.password" value="" />
  <property name="deploy.ssh.path"     value="" />
  <property name="deploy.ssh.port"     value="" />
  <property name="deploy.ssh.username" value="" />

  <!-- ## Main targets -->

  <target name="deploy:start"
          description="Deploys the current working copy to a remote host using FileSync."
          depends="deploy:init, deploy:sync-files" />

  <!-- ## Helper targets -->

  <target name="deploy:init"
          description="Setup steps for deploy build tasks."
          unless="deploy.initialized"
          hidden="true">
    <fail unless="deploy.environment"
          message="Please provide a deploy.environment property." />

    <property file="deploy.${deploy.environment}.properties" override="true" />

    <fail unless="deploy.sourcedir"
          message="Please provide a deploy.sourcedir property." />
    <fail unless="deploy.ssh.host"
          message="Please provide a deploy.ssh.host property." />
    <fail unless="deploy.ssh.port"
          message="Please provide a deploy.ssh.port property." />
    <fail unless="deploy.ssh.path"
          message="Please provide a deploy.ssh.path property." />
    <fail unless="deploy.ssh.username"
          message="Please provide a deploy.ssh.username property." />
    <fail unless="deploy.ssh.password"
          message="Please provide a deploy.ssh.password property." />

    <property name="deploy.initialized" value="true" />
  </target>

  <target name="deploy:sync-files"
          description="Syncs files from local directory to remote server."
          depends="deploy:init"
          hidden="true">
    <filesync sourceDir="${deploy.sourcedir}/"
              destinationDir="${deploy.ssh.username}@${deploy.ssh.host}:${deploy.ssh.path}"
              excludeFile=".deployignore"
              options="-e 'sshpass -p ${deploy.ssh.password} ssh -p ${deploy.ssh.port}' -rpKzl"
              delete="true" />
  </target>

  <target name="deploy:ssh-exec"
          description="Executes commands on remote host via SSH."
          depends="deploy:init"
          hidden="true">
    <fail unless="command"
          message="Please provide a command property." />
    <ssh host="${deploy.ssh.host}"
         port="${deploy.ssh.port}"
         username="${deploy.ssh.username}"
         password="${deploy.ssh.password}"
         command="${command}" />
  </target>

</project>
