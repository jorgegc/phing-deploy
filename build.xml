<?xml version="1.0" encoding="UTF-8"?>

<project name="deploy" default="deploy:start">

  <!-- ## Properties -->

  <property name="deploy.local.path"      value="${project.basedir}/docroot" />
  <property name="deploy.remote.host"     value="${env.DEPLOY_SSH_HOST}" />
  <property name="deploy.remote.password" value="${env.DEPLOY_SSH_PASSWORD}" />
  <property name="deploy.remote.path"     value="${env.DEPLOY_SSH_PATH}" />
  <property name="deploy.remote.port"     value="${env.DEPLOY_SSH_PORT}" />
  <property name="deploy.remote.username" value="${env.DEPLOY_SSH_USERNAME}" />

  <!-- ## Main targets -->

  <target name="deploy:start"
          description="Deploys the current working copy to a remote host using FileSync."
          depends="deploy:init, deploy:sync-files" />

  <!-- ## Helper targets -->

  <target name="deploy:init"
          description="Setup steps for deploy build tasks."
          unless="deploy.initialized"
          hidden="true">
    <fail unless="deploy.local.path"
          message="Please provide a deploy.local.path property." />
    <fail unless="deploy.remote.host"
          message="Please provide a deploy.remote.host property." />
    <fail unless="deploy.remote.port"
          message="Please provide a deploy.remote.port property." />
    <fail unless="deploy.remote.path"
          message="Please provide a deploy.remote.path property." />
    <fail unless="deploy.remote.username"
          message="Please provide a deploy.remote.username property." />
    <fail unless="deploy.remote.password"
          message="Please provide a deploy.remote.password property." />
    <property name="deploy.initialized" value="true" />
  </target>

  <target name="deploy:sync-files"
          description="Syncs files from local directory to remote server."
          depends="deploy:init"
          hidden="true">
    <filesync sourceDir="${deploy.local.path}/"
              destinationDir="${deploy.remote.username}@${deploy.remote.host}:${deploy.remote.path}"
              excludeFile=".deployignore"
              options="-e 'sshpass -p ${deploy.remote.password} ssh -p ${deploy.remote.port}' -rpKzl"
              delete="true" />
  </target>

  <target name="deploy:ssh-exec"
          description="Executes commands on remote host via SSH."
          depends="deploy:init"
          hidden="true">
    <fail unless="command"
          message="Please provide a command property." />
    <ssh host="${deploy.remote.host}"
         port="${deploy.remote.port}"
         username="${deploy.remote.username}"
         password="${deploy.remote.password}"
         command="${command}" />
  </target>

</project>
